<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HVAC Balance Point Grapher</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
    .chart-container { position: relative; height: 70vh; width: 100%; min-height: 400px; }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="max-w-6xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
    <header class="mb-8 border-b pb-4">
      <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">HVAC Balance Point Grapher</h1>
      <p class="text-gray-500 mt-1">Visualize the intersection of your heat pump capacity and home heat load.</p>
    </header>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
      <div class="space-y-6 xl:col-span-1">
        <h2 class="text-xl font-bold text-indigo-600 border-b pb-2">Unit Selection</h2>
        <div class="p-4 bg-indigo-50 rounded-lg shadow-sm space-y-4">
          <div>
            <label for="indoorUnit" class="block text-sm font-semibold text-gray-700 mb-2">1. Select Indoor Unit:</label>
            <select id="indoorUnit"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm">
              <option value="" disabled selected>-- Select Indoor Unit --</option>
            </select>
          </div>
          <div>
            <label for="outdoorUnit" class="block text-sm font-semibold text-gray-700 mb-2">2. Select Outdoor Unit:</label>
            <select id="outdoorUnit"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm">
              <option value="" disabled selected>-- Select Outdoor Unit --</option>
            </select>
          </div>
        </div>

        <h2 class="text-xl font-bold text-blue-600 border-b pb-2 pt-4">House Load Parameters</h2>
        <div class="space-y-4 p-4 bg-blue-50 rounded-lg shadow-sm">
          <div>
            <label for="designLoad" class="block text-sm font-medium text-gray-700">Design Heat Load (kBTU/h):</label>
            <input type="number" id="designLoad" value="50" min="1"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
          </div>
          <div>
            <label for="designTemp" class="block text-sm font-medium text-gray-700">Outdoor Design Temp (°F):</label>
            <input type="number" id="designTemp" value="5"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
          </div>
        </div>
      </div>

      <div class="xl:col-span-2">
        <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
          <!-- Disclaimer added here -->
          <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="text-sm text-yellow-800 text-center">
              <strong>Note:</strong> This calculation assumes an indoor temperature of 70°F. The balance point represents the outdoor temperature where heat pump capacity matches your home's heating requirement.
            </p>
          </div>
          <div class="chart-container">
            <canvas id="balancePointChart"></canvas>
          </div>
        </div>
        <div id="resultOutput" class="bg-green-50 p-6 rounded-xl mt-6 text-center">
          <p class="text-xl font-bold text-gray-700">
            Balance Point: <span id="bpValue" class="text-green-600 text-4xl">--</span>
          </p>
          <p class="text-sm text-gray-600 mt-1" id="bpMessage">Select units and enter parameters to see the result.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let balancePointChart;
    const INDOOR_SETPOINT = 70; // Default indoor temperature

    // Generated HVAC_DATA object from "balance points indoor and outdoor units heating.xlsx - Sheet1.csv"
const HVAC_DATA = {
    "BOVA 15 ODU 2 Ton+BIVA 15 AHU 2 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 26.8 },
            { "temp": 72, "capacity": 24.5 },
            { "temp": 67, "capacity": 24.7 },
            { "temp": 62, "capacity": 24.2 },
            { "temp": 57, "capacity": 25.7 },
            { "temp": 52, "capacity": 24.6 },
            { "temp": 47, "capacity": 24.2 },
            { "temp": 42, "capacity": 23.4 },
            { "temp": 37, "capacity": 22.6 },
            { "temp": 32, "capacity": 23.2 },
            { "temp": 27, "capacity": 22.2 },
            { "temp": 22, "capacity": 21.7 },
            { "temp": 17, "capacity": 20.5 },
            { "temp": 12, "capacity": 19.7 },
            { "temp": 7, "capacity": 17.9 },
            { "temp": 3, "capacity": 16.2 }
        ]
    },
    "BOVA 15 ODU 3 Ton+BIVA 15 AHU 2 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 25.4 },
            { "temp": 72, "capacity": 24.1 },
            { "temp": 67, "capacity": 24.0 },
            { "temp": 62, "capacity": 24.0 },
            { "temp": 57, "capacity": 23.4 },
            { "temp": 52, "capacity": 23.8 },
            { "temp": 47, "capacity": 24.0 },
            { "temp": 42, "capacity": 23.1 },
            { "temp": 37, "capacity": 22.9 },
            { "temp": 32, "capacity": 22.2 },
            { "temp": 27, "capacity": 20.8 },
            { "temp": 22, "capacity": 20.9 },
            { "temp": 17, "capacity": 20.5 },
            { "temp": 12, "capacity": 18.3 },
            { "temp": 7, "capacity": 18.1 },
            { "temp": 3, "capacity": 17.5 }
        ]
    },
    "BOVA 15 ODU 3 Ton+BIVA 15 AHU 3 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 36.7 },
            { "temp": 72, "capacity": 34.0 },
            { "temp": 67, "capacity": 34.1 },
            { "temp": 62, "capacity": 33.3 },
            { "temp": 57, "capacity": 33.8 },
            { "temp": 52, "capacity": 33.4 },
            { "temp": 47, "capacity": 33.0 },
            { "temp": 42, "capacity": 32.6 },
            { "temp": 37, "capacity": 30.9 },
            { "temp": 32, "capacity": 28.7 },
            { "temp": 27, "capacity": 28.3 },
            { "temp": 22, "capacity": 26.7 },
            { "temp": 17, "capacity": 24.7 },
            { "temp": 12, "capacity": 26.0 },
            { "temp": 7, "capacity": 24.4 },
            { "temp": 3, "capacity": 22.8 }
        ]
    },
    "BOVA 15 ODU 5 Ton+BIVA 15 AHU 3 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 51.5 },
            { "temp": 72, "capacity": 45.2 },
            { "temp": 67, "capacity": 44.1 },
            { "temp": 62, "capacity": 41.0 },
            { "temp": 57, "capacity": 40.4 },
            { "temp": 52, "capacity": 38.0 },
            { "temp": 47, "capacity": 35.2 },
            { "temp": 42, "capacity": 32.6 },
            { "temp": 37, "capacity": 30.0 },
            { "temp": 32, "capacity": 27.4 },
            { "temp": 27, "capacity": 25.4 },
            { "temp": 22, "capacity": 38.8 },
            { "temp": 17, "capacity": 29.1 },
            { "temp": 12, "capacity": 29.7 },
            { "temp": 7, "capacity": 28.9 },
            { "temp": 3, "capacity": 26.6 }
        ]
    },
    "BOVA 15 ODU 5 Ton+BIVA 15 AHU 4 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 51.0 },
            { "temp": 72, "capacity": 50.0 },
            { "temp": 67, "capacity": 49.9 },
            { "temp": 62, "capacity": 48.3 },
            { "temp": 57, "capacity": 48.4 },
            { "temp": 52, "capacity": 49.4 },
            { "temp": 47, "capacity": 48.0 },
            { "temp": 42, "capacity": 46.5 },
            { "temp": 37, "capacity": 44.9 },
            { "temp": 32, "capacity": 41.4 },
            { "temp": 27, "capacity": 40.8 },
            { "temp": 22, "capacity": 40.1 },
            { "temp": 17, "capacity": 38.5 },
            { "temp": 12, "capacity": 36.2 },
            { "temp": 7, "capacity": 34.6 },
            { "temp": 3, "capacity": 33.2 }
        ]
    },
    "BOVA 15 ODU 5 Ton+BIVA 15 AHU 5 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 61.2 },
            { "temp": 72, "capacity": 59.0 },
            { "temp": 67, "capacity": 58.4 },
            { "temp": 62, "capacity": 57.7 },
            { "temp": 57, "capacity": 57.8 },
            { "temp": 52, "capacity": 57.2 },
            { "temp": 47, "capacity": 56.0 },
            { "temp": 42, "capacity": 52.5 },
            { "temp": 37, "capacity": 48.8 },
            { "temp": 32, "capacity": 45.2 },
            { "temp": 27, "capacity": 46.7 },
            { "temp": 22, "capacity": 44.5 },
            { "temp": 17, "capacity": 41.4 },
            { "temp": 12, "capacity": 40.2 },
            { "temp": 7, "capacity": 36.5 },
            { "temp": 3, "capacity": 32.6 }
        ]
    },
    "BOVA 15 ODU 2 Ton+BIVA 20 AHU 2 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 28.2 },
            { "temp": 72, "capacity": 24.5 },
            { "temp": 67, "capacity": 23.9 },
            { "temp": 62, "capacity": 22.4 },
            { "temp": 57, "capacity": 22.7 },
            { "temp": 52, "capacity": 21.7 },
            { "temp": 47, "capacity": 20.9 },
            { "temp": 42, "capacity": 19.2 },
            { "temp": 37, "capacity": 18.9 },
            { "temp": 32, "capacity": 21.8 },
            { "temp": 27, "capacity": 20.7 },
            { "temp": 22, "capacity": 21.3 },
            { "temp": 17, "capacity": 16.1 },
            { "temp": 12, "capacity": 16.5 },
            { "temp": 7, "capacity": 15.7 },
            { "temp": 3, "capacity": 15.3 }
        ]
    },
    "BOVA 15 ODU 3 Ton+BIVA 20 AHU 2 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 19.4 },
            { "temp": 72, "capacity": 19.1 },
            { "temp": 67, "capacity": 19.0 },
            { "temp": 62, "capacity": 18.8 },
            { "temp": 57, "capacity": 19.5 },
            { "temp": 52, "capacity": 18.9 },
            { "temp": 47, "capacity": 18.9 },
            { "temp": 42, "capacity": 18.6 },
            { "temp": 37, "capacity": 18.3 },
            { "temp": 32, "capacity": 18.5 },
            { "temp": 27, "capacity": 18.3 },
            { "temp": 22, "capacity": 18.4 },
            { "temp": 17, "capacity": 18.4 },
            { "temp": 12, "capacity": 15.8 },
            { "temp": 7, "capacity": 15.5 },
            { "temp": 3, "capacity": 14.7 }
        ]
    },
    "BOVA 15 ODU 3 Ton+BIVA 20 AHU 3 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 35.4 },
            { "temp": 72, "capacity": 33.8 },
            { "temp": 67, "capacity": 33.4 },
            { "temp": 62, "capacity": 33.3 },
            { "temp": 57, "capacity": 33.5 },
            { "temp": 52, "capacity": 33.4 },
            { "temp": 47, "capacity": 33.0 },
            { "temp": 42, "capacity": 32.2 },
            { "temp": 37, "capacity": 30.5 },
            { "temp": 32, "capacity": 28.3 },
            { "temp": 27, "capacity": 27.8 },
            { "temp": 22, "capacity": 26.2 },
            { "temp": 17, "capacity": 24.2 },
            { "temp": 12, "capacity": 23.8 },
            { "temp": 7, "capacity": 22.1 },
            { "temp": 3, "capacity": 20.6 }
        ]
    },
    "BOVA 15 ODU 5 Ton+BIVA 20 AHU 3 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 48.2 },
            { "temp": 72, "capacity": 42.8 },
            { "temp": 67, "capacity": 41.8 },
            { "temp": 62, "capacity": 39.2 },
            { "temp": 57, "capacity": 37.6 },
            { "temp": 52, "capacity": 35.2 },
            { "temp": 47, "capacity": 33.3 },
            { "temp": 42, "capacity": 30.8 },
            { "temp": 37, "capacity": 28.4 },
            { "temp": 32, "capacity": 26.0 },
            { "temp": 27, "capacity": 24.5 },
            { "temp": 22, "capacity": 24.7 },
            { "temp": 17, "capacity": 29.0 },
            { "temp": 12, "capacity": 29.6 },
            { "temp": 7, "capacity": 30.9 },
            { "temp": 3, "capacity": 30.4 }
        ]
    },
    "BOVA 15 ODU 5 Ton+BIVA 20 AHU 4 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 48.0 },
            { "temp": 72, "capacity": 46.1 },
            { "temp": 67, "capacity": 45.4 },
            { "temp": 62, "capacity": 46.0 },
            { "temp": 57, "capacity": 48.3 },
            { "temp": 52, "capacity": 46.7 },
            { "temp": 47, "capacity": 45.5 },
            { "temp": 42, "capacity": 44.0 },
            { "temp": 37, "capacity": 42.4 },
            { "temp": 32, "capacity": 45.2 },
            { "temp": 27, "capacity": 43.1 },
            { "temp": 22, "capacity": 45.9 },
            { "temp": 17, "capacity": 35.6 },
            { "temp": 12, "capacity": 34.3 },
            { "temp": 7, "capacity": 33.2 },
            { "temp": 3, "capacity": 31.5 }
        ]
    },
    "BOVA 15 ODU 5 Ton+BIVA 20 AHU 5 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 55.5 },
            { "temp": 72, "capacity": 53.2 },
            { "temp": 67, "capacity": 53.3 },
            { "temp": 62, "capacity": 52.9 },
            { "temp": 57, "capacity": 53.1 },
            { "temp": 52, "capacity": 52.6 },
            { "temp": 47, "capacity": 51.8 },
            { "temp": 42, "capacity": 51.6 },
            { "temp": 37, "capacity": 48.3 },
            { "temp": 32, "capacity": 44.5 },
            { "temp": 27, "capacity": 48.1 },
            { "temp": 22, "capacity": 45.3 },
            { "temp": 17, "capacity": 42.6 },
            { "temp": 12, "capacity": 45.4 },
            { "temp": 7, "capacity": 41.9 },
            { "temp": 3, "capacity": 38.3 }
        ]
    },
    "BOVA 20 ODU 3 Ton+BIVA 20 AHU 2 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 21.8 },
            { "temp": 72, "capacity": 21.8 },
            { "temp": 67, "capacity": 21.8 },
            { "temp": 62, "capacity": 21.8 },
            { "temp": 57, "capacity": 21.8 },
            { "temp": 52, "capacity": 21.7 },
            { "temp": 47, "capacity": 21.7 },
            { "temp": 42, "capacity": 21.7 },
            { "temp": 37, "capacity": 21.6 },
            { "temp": 32, "capacity": 21.6 },
            { "temp": 27, "capacity": 21.3 },
            { "temp": 22, "capacity": 21.3 },
            { "temp": 17, "capacity": 20.4 },
            { "temp": 12, "capacity": 19.2 },
            { "temp": 7, "capacity": 18.3 },
            { "temp": 3, "capacity": 17.5 },
            { "temp": -4, "capacity": 16.9 }
        ]
    },
    "BOVA 20 ODU 3 Ton+BIVA 20 AHU 3 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 27.8 },
            { "temp": 72, "capacity": 27.8 },
            { "temp": 67, "capacity": 27.7 },
            { "temp": 62, "capacity": 27.7 },
            { "temp": 57, "capacity": 27.7 },
            { "temp": 52, "capacity": 27.6 },
            { "temp": 47, "capacity": 30.2 },
            { "temp": 42, "capacity": 29.8 },
            { "temp": 37, "capacity": 27.1 },
            { "temp": 32, "capacity": 25.8 },
            { "temp": 27, "capacity": 25.2 },
            { "temp": 22, "capacity": 24.3 },
            { "temp": 17, "capacity": 23.8 },
            { "temp": 12, "capacity": 23.0 },
            { "temp": 7, "capacity": 21.0 },
            { "temp": 3, "capacity": 19.6 },
            { "temp": -4, "capacity": 19.0 }
        ]
    },
    "BOVA 20 ODU 5 Ton+BIVA 20 AHU 4 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 44.7 },
            { "temp": 72, "capacity": 44.7 },
            { "temp": 67, "capacity": 44.6 },
            { "temp": 62, "capacity": 44.5 },
            { "temp": 57, "capacity": 44.5 },
            { "temp": 52, "capacity": 44.4 },
            { "temp": 47, "capacity": 44.8 },
            { "temp": 42, "capacity": 44.8 },
            { "temp": 37, "capacity": 44.8 },
            { "temp": 32, "capacity": 42.4 },
            { "temp": 27, "capacity": 40.3 },
            { "temp": 22, "capacity": 39.1 },
            { "temp": 17, "capacity": 37.3 },
            { "temp": 12, "capacity": 36.1 },
            { "temp": 7, "capacity": 34.3 },
            { "temp": 3, "capacity": 32.6 },
            { "temp": -4, "capacity": 31.0 }
        ]
    },
    "BOVA 20 ODU 5 Ton+BIVA 20 AHU 5 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 46.5 },
            { "temp": 72, "capacity": 46.5 },
            { "temp": 67, "capacity": 46.6 },
            { "temp": 62, "capacity": 46.5 },
            { "temp": 57, "capacity": 46.0 },
            { "temp": 52, "capacity": 45.8 },
            { "temp": 47, "capacity": 42.3 },
            { "temp": 42, "capacity": 45.3 },
            { "temp": 37, "capacity": 41.8 },
            { "temp": 32, "capacity": 39.4 },
            { "temp": 27, "capacity": 42.3 },
            { "temp": 22, "capacity": 41.0 },
            { "temp": 17, "capacity": 40.5 },
            { "temp": 12, "capacity": 37.6 },
            { "temp": 7, "capacity": 34.4 },
            { "temp": 3, "capacity": 31.0 },
            { "temp": -4, "capacity": 28.0 }
        ]
    },
    "BOVA 19 ODU 5 Ton+BIVA 19 AHU 4 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 43.3 },
            { "temp": 72, "capacity": 43.7 },
            { "temp": 67, "capacity": 43.3 },
            { "temp": 62, "capacity": 42.8 },
            { "temp": 57, "capacity": 42.3 },
            { "temp": 52, "capacity": 41.8 },
            { "temp": 47, "capacity": 41.3 },
            { "temp": 42, "capacity": 39.8 },
            { "temp": 37, "capacity": 39.3 },
            { "temp": 32, "capacity": 38.3 },
            { "temp": 27, "capacity": 36.8 },
            { "temp": 22, "capacity": 35.3 },
            { "temp": 17, "capacity": 33.8 },
            { "temp": 12, "capacity": 31.3 },
            { "temp": 7, "capacity": 28.8 },
            { "temp": 3, "capacity": 26.3 },
            { "temp": -4, "capacity": 22.8 },
            { "temp": -10, "capacity": 21.3 }
        ]
    },
    "BOVA 19 ODU 5 Ton+BIVA 19 AHU 5 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 47.9 },
            { "temp": 72, "capacity": 47.4 },
            { "temp": 67, "capacity": 46.9 },
            { "temp": 62, "capacity": 46.4 },
            { "temp": 57, "capacity": 45.9 },
            { "temp": 52, "capacity": 45.4 },
            { "temp": 47, "capacity": 44.9 },
            { "temp": 42, "capacity": 43.9 },
            { "temp": 37, "capacity": 43.4 },
            { "temp": 32, "capacity": 42.4 },
            { "temp": 27, "capacity": 40.9 },
            { "temp": 22, "capacity": 39.4 },
            { "temp": 17, "capacity": 37.9 },
            { "temp": 12, "capacity": 35.4 },
            { "temp": 7, "capacity": 32.9 },
            { "temp": 3, "capacity": 30.4 },
            { "temp": -4, "capacity": 26.9 },
            { "temp": -10, "capacity": 25.4 }
        ]
    },
    "BOVA 20 ODU 4 Ton+BIVA 20 AHU 4 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 42.8 },
            { "temp": 72, "capacity": 42.8 },
            { "temp": 67, "capacity": 42.8 },
            { "temp": 62, "capacity": 42.8 },
            { "temp": 57, "capacity": 42.8 },
            { "temp": 52, "capacity": 42.7 },
            { "temp": 47, "capacity": 42.7 },
            { "temp": 42, "capacity": 42.7 },
            { "temp": 37, "capacity": 42.6 },
            { "temp": 32, "capacity": 40.5 },
            { "temp": 27, "capacity": 39.2 },
            { "temp": 22, "capacity": 38.3 },
            { "temp": 17, "capacity": 36.6 },
            { "temp": 12, "capacity": 35.5 },
            { "temp": 7, "capacity": 34.0 },
            { "temp": 3, "capacity": 32.7 },
            { "temp": -4, "capacity": 31.0 }
        ]
    },
    "BOVA 20 ODU 4 Ton+BIVA 20 AHU 5 Ton": {
        "ratings": [
            { "temp": 86, "capacity": 43.5 },
            { "temp": 72, "capacity": 43.5 },
            { "temp": 67, "capacity": 43.6 },
            { "temp": 62, "capacity": 43.5 },
            { "temp": 57, "capacity": 43.0 },
            { "temp": 52, "capacity": 42.8 },
            { "temp": 47, "capacity": 39.3 },
            { "temp": 42, "capacity": 42.3 },
            { "temp": 37, "capacity": 38.8 },
            { "temp": 32, "capacity": 36.4 },
            { "temp": 27, "capacity": 39.3 },
            { "temp": 22, "capacity": 38.0 },
            { "temp": 17, "capacity": 37.5 },
            { "temp": 12, "capacity": 34.6 },
            { "temp": 7, "capacity": 31.4 },
            { "temp": 3, "capacity": 28.0 },
            { "temp": -4, "capacity": 25.0 }
        ]
    }
};

    document.addEventListener('DOMContentLoaded', () => {
      populateIndoorUnits();
      document.getElementById('indoorUnit').addEventListener('change', populateOutdoorUnits);
      document.getElementById('outdoorUnit').addEventListener('change', calculateAndPlot);
      document.getElementById('designLoad').addEventListener('input', calculateAndPlot);
      document.getElementById('designTemp').addEventListener('input', calculateAndPlot);
      plotChart([], []);
    });

    function populateIndoorUnits() {
      const indoorSelect = document.getElementById('indoorUnit');
      // Extract unique indoor units from HVAC_DATA keys
      const indoorUnits = [...new Set(Object.keys(HVAC_DATA).map(k => {
        const parts = k.split('+');
        return parts.length > 1 ? parts[1] : null;
      }).filter(Boolean))];
      
      indoorUnits.forEach(unit => {
        const opt = document.createElement('option');
        opt.value = unit; 
        opt.textContent = unit;
        indoorSelect.appendChild(opt);
      });
    }

    function populateOutdoorUnits() {
      const indoorUnit = document.getElementById('indoorUnit').value;
      const outdoorSelect = document.getElementById('outdoorUnit');
      outdoorSelect.innerHTML = '<option value="" disabled selected>-- Select Outdoor Unit --</option>';

      if (!indoorUnit) return;

      const outdoorUnits = Object.keys(HVAC_DATA)
        .filter(k => k.endsWith('+' + indoorUnit))
        .map(k => k.split('+')[0]);

      outdoorUnits.forEach(unit => {
        const opt = document.createElement('option');
        opt.value = unit;
        opt.textContent = unit;
        outdoorSelect.appendChild(opt);
      });

      // Auto-select if only one match
      if (outdoorUnits.length === 1) {
        outdoorSelect.value = outdoorUnits[0];
        calculateAndPlot();
      }
    }

    function calculateAndPlot() {
      const indoor = document.getElementById('indoorUnit').value;
      const outdoor = document.getElementById('outdoorUnit').value;
      const key = `${outdoor}+${indoor}`;
      const bpValueEl = document.getElementById('bpValue');
      const bpMessageEl = document.getElementById('bpMessage');

      if (!indoor || !outdoor || !HVAC_DATA[key]) {
        bpValueEl.textContent = '--';
        bpMessageEl.textContent = 'Select a valid indoor/outdoor combination.';
        plotChart([], []);
        return;
      }

      const designLoad = parseFloat(document.getElementById('designLoad').value);
      const designTemp = parseFloat(document.getElementById('designTemp').value);

      if (isNaN(designLoad) || isNaN(designTemp)) {
        bpValueEl.textContent = '--';
        bpMessageEl.textContent = 'Please enter valid numbers for design load and temperature.';
        return;
      }

      const houseLoadFn = t => {
        if (t >= INDOOR_SETPOINT) return 0;
        const K = designLoad / (INDOOR_SETPOINT - designTemp);
        return K * (INDOOR_SETPOINT - t);
      };

      const bpResult = findBalancePoint(HVAC_DATA[key].ratings, houseLoadFn);
      let intersectionPoint = null, finalBP = null;

      if (typeof bpResult === 'number') {
        finalBP = parseFloat(bpResult.toFixed(1));
        const cap = houseLoadFn(finalBP);
        intersectionPoint = { x: finalBP, y: cap };
        bpValueEl.textContent = `${finalBP}°F`;
        bpMessageEl.textContent = `Heat pump capacity = ${cap.toFixed(1)} kBTU/h`;
      } else {
        bpValueEl.textContent = '--';
        bpMessageEl.textContent = bpResult;
      }

      const hpPoints = HVAC_DATA[key].ratings.map(r => ({ x: r.temp, y: r.capacity }));
      const loadPoints = [];
      
      // Generate house load points from indoor setpoint down to design temp
      const minTemp = Math.min(...HVAC_DATA[key].ratings.map(r => r.temp));
      const maxTemp = Math.max(...HVAC_DATA[key].ratings.map(r => r.temp));
      
      for (let t = Math.max(INDOOR_SETPOINT, maxTemp); t >= Math.min(designTemp, minTemp); t -= 2) {
        loadPoints.push({ x: t, y: houseLoadFn(t) });
      }
      
      // Ensure key points are included
      if (!loadPoints.some(p => p.x === designTemp)) {
        loadPoints.push({ x: designTemp, y: designLoad });
      }

      plotChart(hpPoints, loadPoints, intersectionPoint, key, finalBP);
    }

    function findBalancePoint(ratings, houseLoadFn) {
      // Sort ratings in descending temperature order
      ratings.sort((a, b) => b.temp - a.temp);
      
      for (let i = 0; i < ratings.length - 1; i++) {
        const t1 = ratings[i].temp;
        const t2 = ratings[i + 1].temp;
        const cap1 = ratings[i].capacity;
        const cap2 = ratings[i + 1].capacity;

        const load1 = houseLoadFn(t1);
        const load2 = houseLoadFn(t2);
        
        const net1 = cap1 - load1;
        const net2 = cap2 - load2;

        // Check for intersection between these two points
        if ((net1 >= 0 && net2 <= 0) || (net1 <= 0 && net2 >= 0)) {
          // Linear interpolation to find the exact intersection
          const t = t1 - (net1 * (t1 - t2)) / (net1 - net2);
          return t;
        }
      }
      
      // Check edge cases
      const firstRating = ratings[0];
      const lastRating = ratings[ratings.length - 1];
      
      if (firstRating.capacity > houseLoadFn(firstRating.temp)) {
        return `Balance Point is above ${firstRating.temp}°F. Heat pump meets load even at high temps.`;
      }
      
      if (lastRating.capacity < houseLoadFn(lastRating.temp)) {
        return `Balance Point is below ${lastRating.temp}°F. Auxiliary heat required.`;
      }

      return "No clear intersection found within the rating data.";
    }

    function plotChart(hpPoints, loadPoints, intersectionPoint, key, finalBP) {
      const ctx = document.getElementById('balancePointChart').getContext('2d');
      if (balancePointChart) balancePointChart.destroy();
      
      const datasets = [
        { 
          label: 'Heat Pump Capacity', 
          data: hpPoints, 
          borderColor: '#4f46e5', 
          backgroundColor: 'rgba(79,70,229,0.1)', 
          tension: 0.3,
          fill: false,
          pointBackgroundColor: '#4f46e5',
          pointRadius: 4,
          pointHoverRadius: 6
        },
        { 
          label: 'House Load', 
          data: loadPoints, 
          borderColor: '#ef4444', 
          backgroundColor: 'rgba(239,68,68,0.1)', 
          borderDash: [5,5],
          fill: false,
          pointBackgroundColor: '#ef4444',
          pointRadius: 2,
          pointHoverRadius: 4
        }
      ];
      
      if (intersectionPoint) {
        datasets.push({ 
          label: `Balance Point`, 
          data: [intersectionPoint], 
          type: 'scatter', 
          backgroundColor: '#10b981', 
          pointRadius: 8, 
          pointStyle: 'circle',
          borderColor: '#059669',
          borderWidth: 2
        });
      }

      balancePointChart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
            padding: {
              top: 20,
              right: 20,
              bottom: 40, // Increased bottom padding for x-axis labels
              left: 20
            }
          },
          plugins: { 
            title: { 
              display: true, 
              text: key || 'Select Units',
              font: { size: 16 },
              padding: { bottom: 15 }
            }, 
            legend: { 
              position: 'top',
              labels: { 
                font: { size: 14 },
                padding: 15,
                usePointStyle: true
              },
              align: 'center'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              padding: 10,
              bodySpacing: 5
            }
          },
          scales: { 
            x: { 
              type: 'linear', 
              reverse: false,
              title: { 
                display: true, 
                text: 'Outdoor Temp (°F)',
                font: { size: 14, weight: 'bold' },
                padding: { top: 10, bottom: 10 }
              },
              grid: { 
                color: 'rgba(0,0,0,0.1)',
                drawBorder: true
              },
              ticks: {
                padding: 8,
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 10
              },
              // Set proper bounds for the x-axis
              min: function() {
                const allPoints = [...hpPoints, ...loadPoints];
                const minVal = Math.min(...allPoints.map(p => p.x));
                return Math.floor(minVal - 2);
              },
              max: function() {
                const allPoints = [...hpPoints, ...loadPoints];
                const maxVal = Math.max(...allPoints.map(p => p.x));
                return Math.ceil(maxVal + 2);
              }
            }, 
            y: { 
              title: { 
                display: true, 
                text: 'Capacity (kBTU/h)',
                font: { size: 14, weight: 'bold' },
                padding: { top: 10, bottom: 10 }
              }, 
              beginAtZero: true,
              grid: { 
                color: 'rgba(0,0,0,0.1)',
                drawBorder: true
              },
              ticks: {
                padding: 8,
                maxTicksLimit: 8
              }
            } 
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
    }
  </script>
</body>
</html>
